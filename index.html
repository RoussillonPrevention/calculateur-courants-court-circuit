import math
from typing import Dict, Tuple

def calculate_short_circuit_currents(
    transformer_power_kva: float,
    coupling: str,
    ucc_percent: float,
    winding_material: str,
    cable_length_m: float,
    installation_method: str,
    phase_conductor_section: float,
    phase_conductors_per_phase: int,
    neutral_conductor_section: float,
    neutral_conductors: int,
    network_voltage: float = 400  # Tension triphasée en V
) -> Dict[str, float]:
    """
    Calcule les courants de court-circuit triphasé (Ik3), biphasé (Ik2) et monophasé (Ik1).
    
    Args:
        transformer_power_kva: Puissance du transformateur en kVA (25-2500)
        coupling: Couplage du transformateur ("Dyn11", "Yyn0", etc.)
        ucc_percent: Tension de court-circuit en %
        winding_material: Matériau des enroulements ("cuivre" ou "aluminium")
        cable_length_m: Longueur de la canalisation en mètres
        installation_method: Méthode d'installation de la canalisation
        phase_conductor_section: Section des conducteurs de phase en mm²
        phase_conductors_per_phase: Nombre de conducteurs par phase (1-4)
        neutral_conductor_section: Section du conducteur de neutre en mm²
        neutral_conductors: Nombre de conducteurs de neutre (1-4)
        network_voltage: Tension réseau phase-phase en V (par défaut 400V)
    
    Returns:
        Dictionnaire avec les courants de court-circuit en kA:
        {"Ik3": valeur, "Ik2": valeur, "Ik1": valeur}
    """
    
    # 1. Calcul de l'impédance du transformateur
    sn = transformer_power_kva * 1000  # Puissance en VA
    u_cc = ucc_percent / 100
    zt_per_phase = (u_cc * network_voltage**2) / sn
    
    # Facteur de résistance selon le matériau
    if winding_material.lower() == "cuivre":
        r_ratio = 0.02  # Rapport R/X pour cuivre
    else:
        r_ratio = 0.04  # Rapport R/X pour aluminium
    
    rt_per_phase = zt_per_phase * r_ratio
    xt_per_phase = math.sqrt(zt_per_phase**2 - rt_per_phase**2)
    
    # 2. Calcul de l'impédance des câbles
    # Résistivité des conducteurs (Ω.mm²/m)
    rho_cu = 0.0225  # Cuivre à 20°C
    rho_al = 0.036  # Aluminium à 20°C
    
    # Résistance des câbles de phase
    r_phase = (rho_cu * cable_length_m) / (phase_conductor_section * phase_conductors_per_phase)
    
    # Réactance des câbles selon méthode d'installation
    if installation_method == "Multi":
        x_phase = 0.08 * cable_length_m  # Réactance en mΩ/m pour multiconducteurs
    elif installation_method == "Monoconducteurs en trêfle":
        x_phase = 0.10 * cable_length_m
    elif installation_method == "Monoconducteurs jointifs":
        x_phase = 0.13 * cable_length_m
    elif installation_method == "Monoconducteurs espacés":
        x_phase = 0.15 * cable_length_m
    else:
        x_phase = 0.10 * cable_length_m  # Valeur par défaut
    
    # Conversion en ohms
    x_phase /= 1000
    
    # Impédance totale de phase
    r_total = rt_per_phase + r_phase
    x_total = xt_per_phase + x_phase
    z_total = math.sqrt(r_total**2 + x_total**2)
    
    # 3. Calcul des courants de court-circuit
    # Courant triphasé Ik3
    ik3 = (network_voltage / math.sqrt(3)) / z_total
    
    # Courant biphasé Ik2
    ik2 = (network_voltage / 2) / z_total
    
    # Courant monophasé Ik1
    # Calcul de l'impédance du neutre
    r_neutral = (rho_cu * cable_length_m) / (neutral_conductor_section * neutral_conductors)
    # On suppose la même réactance que les phases (approximation)
    z_neutral = math.sqrt(r_neutral**2 + x_phase**2)
    
    # Impédance homopolaire (simplifiée)
    z0 = 3 * z_neutral
    
    ik1 = (network_voltage / math.sqrt(3)) / (2*z_total + z0)
    
    return {
        "Ik3": round(ik3 / 1000, 2),  # Conversion en kA
        "Ik2": round(ik2 / 1000, 2),
        "Ik1": round(ik1 / 1000, 2)
    }

def get_help_section() -> str:
    """Retourne une section d'aide avec les explications des termes techniques"""
    return """
    AIDE - EXPLICATION DES TERMES TECHNIQUES
    
    1. Puissance du transformateur (kVA):
    La puissance apparente que peut délivrer le transformateur. Les valeurs standard vont de 25 kVA à 2500 kVA.
    
    2. Couplage du transformateur:
    Configuration des enroulements (ex: Dyn11, Yyn0). Affecte le comportement en court-circuit.
    
    3. Tension de court-circuit (Ucc %):
    Pourcentage de tension qu'il faut appliquer au primaire pour que le secondaire débite son courant nominal en court-circuit.
    
    4. Matériau des enroulements:
    Cuivre (meilleure conductivité) ou aluminium (plus léger et moins cher).
    
    5. Méthode d'installation:
    - Multi: Câble multiconducteur
    - Monoconducteurs en trêfle: Conducteurs séparés disposés en triangle
    - Monoconducteurs jointifs: Conducteurs séparés côte à côte
    - Monoconducteurs espacés: Conducteurs séparés avec espacement
    
    6. Courants de court-circuit:
    - Ik3: Courant de court-circuit triphasé (le plus sévère)
    - Ik2: Courant de court-circuit biphasé
    - Ik1: Courant de court-circuit monophasé (implique le neutre)
    
    7. Impédance:
    Opposition totale d'un circuit au courant alternatif, composée de:
    - Résistance (R): Opposition au courant continu
    - Réactance (X): Opposition due à l'inductance/capacité
    """

# Exemple d'utilisation
if __name__ == "__main__":
    # Paramètres d'entrée
    params = {
        "transformer_power_kva": 400,
        "coupling": "Dyn11",
        "ucc_percent": 4,
        "winding_material": "cuivre",
        "cable_length_m": 50,
        "installation_method": "Multi",
        "phase_conductor_section": 95,
        "phase_conductors_per_phase": 1,
        "neutral_conductor_section": 95,
        "neutral_conductors": 1
    }
    
    # Calcul des courants de court-circuit
    results = calculate_short_circuit_currents(**params)
    
    # Affichage des résultats avec couleurs
    print("\nRésultats des calculs de court-circuit:")
    print(f"Ik3 (triphasé): \033[91m{results['Ik3']} kA\033[0m")  # Rouge
    print(f"Ik2 (biphasé): \033[92m{results['Ik2']} kA\033[0m")   # Vert
    print(f"Ik1 (monophasé): \033[94m{results['Ik1']} kA\033[0m") # Bleu
    
    # Affichage de l'aide si besoin
    help_request = input("\nVoulez-vous voir l'aide technique ? (o/n): ")
    if help_request.lower() == 'o':
        print(get_help_section())
